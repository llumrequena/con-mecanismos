<!DOCTYPE html> 
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LLUM REQUENA">
    <title>LLUM REQUENA - Gestión de Obras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #FF8C00;
            --secondary: #FF6B00;
            --accent: #FFB84D;
            --light: #FFF4E6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        .gradient-light {
            background: linear-gradient(135deg, var(--light) 0%, #ffffff 100%);
        }
        
        .hidden {
            display: none !important;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }
        
        .tab-active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }
        
        .card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 999;
        }
        
        .logo-icon {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 2px;
            transform: rotate(12deg);
            clip-path: polygon(0 0, 70% 0, 100% 100%, 30% 100%);
        }
        
        /* Optimización para iPhone */
        @media (max-width: 480px) {
            .grid-cols-1 {
                grid-template-columns: 1fr;
            }
            
            .modal .max-w-2xl {
                max-width: 95%;
                margin: 1rem;
            }
            
            .overflow-x-auto {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .overflow-x-auto::-webkit-scrollbar {
                display: none;
            }
            
            .text-xs {
                font-size: 0.7rem;
            }
        }
        
        /* Optimización táctil */
        .btn, button, input, textarea, select {
            min-height: 44px;
            touch-action: manipulation;
        }
        
        input, textarea, select {
            -webkit-appearance: none;
            appearance: none;
            border-radius: 8px;
        }
        
        /* Evitar zoom en inputs */
        input, textarea, select {
            font-size: 16px;
        }
        
        /* Safe area para iPhone */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .sticky-top {
            position: sticky;
            top: env(safe-area-inset-top);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="sticky-top z-40 bg-white shadow-sm border-b-2" style="border-color: var(--accent)">
        <div class="flex items-center justify-between p-4 gradient-light">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center gradient-bg">
                    <div class="logo-icon"></div>
                </div>
                <div>
                    <h1 class="text-xl font-bold" style="color: var(--primary)">LLUM REQUENA</h1>
                    <p class="text-xs text-gray-500">Gestión de Obras</p>
                </div>
            </div>
            
            <button id="btnNuevaObra" class="flex items-center gap-2 text-white py-2 px-4 rounded-lg shadow-md btn gradient-bg">
                <span>+</span>
                Nueva Obra
            </button>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex border-b">
            <button id="tabObras" class="flex items-center gap-2 px-4 py-3 border-b-2 tab-active">
                <span>📄</span>
                Obras
            </button>
            <button id="tabResumen" class="flex items-center gap-2 px-4 py-3 border-b-2 border-transparent text-gray-500">
                <span>📊</span>
                Resumen
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="p-4 pb-20">
        <!-- Obras Tab -->
        <div id="contentObras" class="space-y-4">
            <!-- Search -->
            <div class="relative">
                <span class="absolute left-3 top-3 text-gray-400">🔍</span>
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Buscar obras..."
                    class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2"
                    style="--tw-ring-color: var(--primary)"
                />
            </div>

            <!-- Obras Grid -->
            <div id="obrasGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Las obras se cargarán aquí dinámicamente -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12 hidden">
                <span class="text-4xl text-gray-400 mb-4 block">📄</span>
                <h3 class="text-lg font-medium text-gray-500 mb-2">No hay obras registradas</h3>
                <p class="text-gray-400">Comienza creando tu primera obra</p>
            </div>
        </div>

        <!-- Resumen Tab -->
        <div id="contentResumen" class="space-y-6 hidden">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h3 class="text-sm font-medium text-gray-500">Total Obras</h3>
                    <p id="totalObras" class="text-2xl font-bold" style="color: var(--primary)">0</p>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h3 class="text-sm font-medium text-gray-500">En Curso</h3>
                    <p id="obrasEnCurso" class="text-2xl font-bold text-blue-600">0</p>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h3 class="text-sm font-medium text-gray-500">Terminadas</h3>
                    <p id="obrasTerminadas" class="text-2xl font-bold text-green-600">0</p>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h3 class="text-sm font-medium text-gray-500">Pausadas</h3>
                    <p id="obrasPausadas" class="text-2xl font-bold text-red-600">0</p>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold mb-4">Obras Recientes</h3>
                <div id="obrasRecientes" class="space-y-3">
                    <!-- Las obras recientes se cargarán aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva/Editar Obra -->
    <div id="modalObra" class="modal hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto mx-4">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4" style="color: var(--primary)">Nueva Obra</h2>
            
            <form id="formObra" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Nombre de la Obra</label>
                        <input type="text" id="nombre" name="nombre" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cliente</label>
                        <input type="text" id="cliente" name="cliente" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Dirección</label>
                    <input type="text" id="direccion" name="direccion" class="w-full border rounded-lg px-3 py-2">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Estado</label>
                        <select id="estado" name="estado" class="w-full border rounded-lg px-3 py-2">
                            <option value="planificacion">Planificación</option>
                            <option value="en_curso">En Curso</option>
                            <option value="pausada">Pausada</option>
                            <option value="terminada">Terminada</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Presupuesto (€)</label>
                        <input type="number" id="presupuesto" name="presupuesto" class="w-full border rounded-lg px-3 py-2" step="0.01">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Fecha de Inicio</label>
                        <input type="date" id="fechaInicio" name="fechaInicio" class="w-full border rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Fecha Estimada de Fin</label>
                        <input type="date" id="fechaEstimadaFin" name="fechaEstimadaFin" class="w-full border rounded-lg px-3 py-2">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Descripción</label>
                    <textarea id="descripcion" name="descripcion" rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 text-white py-2 px-4 rounded-lg font-medium btn gradient-bg">
                        Guardar Obra
                    </button>
                    <button type="button" id="btnCancelar" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg font-medium">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalle Obra -->
    <div id="modalDetalle" class="fullscreen hidden">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b gradient-light">
                <h2 id="detalleTitle" class="text-xl font-bold" style="color: var(--primary)">Detalle de Obra</h2>
                <button id="btnCerrarDetalle" class="p-2 rounded-lg bg-gray-200 hover:bg-gray-300">✕</button>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col">
                <div class="flex overflow-x-auto border-b">
                    <button id="tabResumenDetalle" class="flex items-center gap-2 px-4 py-3 whitespace-nowrap border-b-2 tab-active">
                        <span>📄</span>
                        Resumen
                    </button>
                    <button id="tabMateriales" class="flex items-center gap-2 px-4 py-3 whitespace-nowrap border-b-2 border-transparent text-gray-500">
                        <span>💰</span>
                        Materiales
                    </button>
                    <button id="tabHoras" class="flex items-center gap-2 px-4 py-3 whitespace-nowrap border-b-2 border-transparent text-gray-500">
                        <span>⏰</span>
                        Horas
                    </button>
                    <button id="tabFases" class="flex items-center gap-2 px-4 py-3 whitespace-nowrap border-b-2 border-transparent text-gray-500">
                        <span>✅</span>
                        Fases
                    </button>
                    <button id="tabFotos" class="flex items-center gap-2 px-4 py-3 whitespace-nowrap border-b-2 border-transparent text-gray-500">
                        <span>📷</span>
                        Fotos
                    </button>
                    <button id="tabMecanismos" class="flex items-center gap-2 px-4 py-3 whitespace-nowrap border-b-2 border-transparent text-gray-500">
                        <span>🔌</span>
                        Mecanismos
                    </button>
                    <button id="tabComentarios" class="flex items-center gap-2 px-4 py-3 whitespace-nowrap border-b-2 border-transparent text-gray-500">
                        <span>💬</span>
                        Comentarios
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-4">
                    <div id="detalleContent">
                        <!-- El contenido se cargará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado global de la aplicación
        let appState = {
            obras: JSON.parse(localStorage.getItem('obras') || '[]'),
            activeTab: 'obras',
            activeDetailTab: 'resumen',
            selectedObra: null,
            editingObra: null,
            searchTerm: ''
        };

        // Datos de configuración
        const estadosObra = [
            { id: 'planificacion', nombre: 'Planificación', color: '#f59e0b' },
            { id: 'en_curso', nombre: 'En Curso', color: '#FF8C00' },
            { id: 'pausada', nombre: 'Pausada', color: '#ef4444' },
            { id: 'terminada', nombre: 'Terminada', color: '#10b981' }
        ];

        const fasesComunes = [
            'Instalación de cuadro eléctrico',
            'Canalización y tubos',
            'Cableado general',
            'Puntos de luz',
            'Enchufes y tomas',
            'Conexiones especiales',
            'Pruebas y certificación'
        ];

        const tiposMecanismos = [
            { id: 'interruptor', nombre: 'Interruptor' },
            { id: 'conmutador', nombre: 'Conmutador' },
            { id: 'cruzamiento', nombre: 'Cruzamiento' },
            { id: 'tc_punto_luz', nombre: 'TC Punto de Luz' },
            { id: 'red_tv', nombre: 'Red TV' },
            { id: 'persiana', nombre: 'Persiana' },
            { id: 'exterior', nombre: 'Exterior' },
            { id: 'marco_1', nombre: 'Marco de 1' },
            { id: 'marco_2', nombre: 'Marco de 2' },
            { id: 'marco_3', nombre: 'Marco de 3' },
            { id: 'marco_4', nombre: 'Marco de 4' },
            { id: 'pulsador', nombre: 'Pulsador' }
        ];

        // Funciones de utilidad
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function saveData() {
            localStorage.setItem('obras', JSON.stringify(appState.obras));
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('es-ES');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        function getEstadoInfo(estadoId) {
            return estadosObra.find(e => e.id === estadoId) || estadosObra[0];
        }

        // Funciones de renderizado
        function renderObras() {
            const grid = document.getElementById('obrasGrid');
            const emptyState = document.getElementById('emptyState');
            
            const filteredObras = appState.obras.filter(obra =>
                obra.nombre.toLowerCase().includes(appState.searchTerm.toLowerCase()) ||
                obra.cliente.toLowerCase().includes(appState.searchTerm.toLowerCase())
            );

            if (filteredObras.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            grid.innerHTML = filteredObras.map(obra => {
                const estadoInfo = getEstadoInfo(obra.estado);
                return `
                    <div class="bg-white rounded-lg shadow-sm border p-4 card">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-semibold text-lg">${obra.nombre}</h3>
                            <span class="px-2 py-1 rounded text-xs text-white" style="background-color: ${estadoInfo.color}">
                                ${estadoInfo.nombre}
                            </span>
                        </div>
                        
                        <div class="space-y-2 text-sm text-gray-600">
                            <p><strong>Cliente:</strong> ${obra.cliente}</p>
                            <p><strong>Dirección:</strong> ${obra.direccion || 'No especificada'}</p>
                            <p><strong>Presupuesto:</strong> ${formatCurrency(obra.presupuesto || 0)}</p>
                        </div>
                        
                        <div class="flex gap-2 mt-4">
                            <button onclick="verDetalle('${obra.id}')" class="flex-1 text-white py-2 px-3 rounded-lg text-sm btn gradient-bg">
                                Ver Detalles
                            </button>
                            <button onclick="editarObra('${obra.id}')" class="p-2 rounded-lg hover:bg-gray-100 transition-colors bg-gray-50">
                                <span style="color: var(--primary)">✏️</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderResumen() {
            const total = appState.obras.length;
            const enCurso = appState.obras.filter(o => o.estado === 'en_curso').length;
            const terminadas = appState.obras.filter(o => o.estado === 'terminada').length;
            const pausadas = appState.obras.filter(o => o.estado === 'pausada').length;

            document.getElementById('totalObras').textContent = total;
            document.getElementById('obrasEnCurso').textContent = enCurso;
            document.getElementById('obrasTerminadas').textContent = terminadas;
            document.getElementById('obrasPausadas').textContent = pausadas;

            const obrasRecientes = document.getElementById('obrasRecientes');
            if (appState.obras.length === 0) {
                obrasRecientes.innerHTML = '<p class="text-gray-500">No hay obras registradas</p>';
                return;
            }

            const sortedObras = [...appState.obras].sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion));
            obrasRecientes.innerHTML = sortedObras.slice(0, 5).map(obra => {
                const estadoInfo = getEstadoInfo(obra.estado);
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <h4 class="font-medium">${obra.nombre}</h4>
                            <p class="text-sm text-gray-500">${obra.cliente}</p>
                        </div>
                        <span class="px-2 py-1 rounded text-xs text-white" style="background-color: ${estadoInfo.color}">
                            ${estadoInfo.nombre}
                        </span>
                    </div>
                `;
            }).join('');
        }

        function renderDetalleContent() {
            const content = document.getElementById('detalleContent');
            const obra = appState.selectedObra;
            
            if (!obra) return;

            switch (appState.activeDetailTab) {
                case 'resumen':
                    content.innerHTML = renderResumenDetalle(obra);
                    break;
                case 'materiales':
                    content.innerHTML = renderMateriales(obra);
                    break;
                case 'horas':
                    content.innerHTML = renderHoras(obra);
                    break;
                case 'fases':
                    content.innerHTML = renderFases(obra);
                    break;
                case 'fotos':
                    content.innerHTML = renderFotos(obra);
                    break;
                case 'mecanismos':
                    content.innerHTML = renderMecanismos(obra);
                    break;
                case 'comentarios':
                    content.innerHTML = renderComentarios(obra);
                    break;
            }
        }

        function renderResumenDetalle(obra) {
            const estadoInfo = getEstadoInfo(obra.estado);
            const totalMateriales = obra.materiales ? obra.materiales.reduce((sum, m) => sum + parseFloat(m.precio || 0), 0) : 0;
            const totalHoras = obra.horas ? obra.horas.reduce((sum, h) => sum + parseFloat(h.horas || 0), 0) : 0;
            const fasesPendientes = obra.fasesPendientes ? obra.fasesPendientes.length : 0;

            return `
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Información General</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div><strong>Cliente:</strong> ${obra.cliente}</div>
                            <div><strong>Dirección:</strong> ${obra.direccion || 'No especificada'}</div>
                            <div><strong>Estado:</strong> 
                                <span class="ml-2 px-2 py-1 rounded text-white text-xs" style="background-color: ${estadoInfo.color}">
                                    ${estadoInfo.nombre}
                                </span>
                            </div>
                            <div><strong>Presupuesto:</strong> ${formatCurrency(obra.presupuesto || 0)}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-800">Total Materiales</h4>
                            <p class="text-2xl font-bold text-blue-600">${formatCurrency(totalMateriales)}</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <h4 class="font-semibold text-green-800">Total Horas</h4>
                            <p class="text-2xl font-bold text-green-600">${totalHoras.toFixed(1)}h</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <h4 class="font-semibold text-purple-800">Fases Pendientes</h4>
                            <p class="text-2xl font-bold text-purple-600">${fasesPendientes}</p>
                        </div>
                    </div>

                    ${obra.descripcion ? `
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold mb-2">Descripción</h3>
                            <p class="text-sm">${obra.descripcion}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderMateriales(obra) {
            const totalMateriales = obra.materiales ? obra.materiales.reduce((sum, m) => sum + parseFloat(m.precio || 0), 0) : 0;

            return `
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-4">Agregar Material</h3>
                        <div class="grid grid-cols-1 gap-3">
                            <input type="text" id="newMaterialNombre" placeholder="Nombre del material" class="border rounded-lg px-3 py-2">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="newMaterialCantidad" placeholder="Cantidad" class="border rounded-lg px-3 py-2">
                                <input type="number" id="newMaterialPrecio" placeholder="Precio (€)" class="border rounded-lg px-3 py-2" step="0.01">
                            </div>
                            <button onclick="agregarMaterial()" class="text-white py-2 px-4 rounded-lg btn gradient-bg">Agregar</button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        ${obra.materiales ? obra.materiales.map(material => `
                            <div class="bg-white border rounded-lg p-3 flex justify-between items-center">
                                <div>
                                    <h4 class="font-medium">${material.nombre}</h4>
                                    <p class="text-sm text-gray-600">Cantidad: ${material.cantidad}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold">${formatCurrency(material.precio)}</p>
                                    <button onclick="eliminarMaterial('${material.id}')" class="text-red-500 text-sm">Eliminar</button>
                                </div>
                            </div>
                        `).join('') : ''}
                    </div>

                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-800">Total: ${formatCurrency(totalMateriales)}</h3>
                    </div>
                </div>
            `;
        }

        function renderHoras(obra) {
            const totalHoras = obra.horas ? obra.horas.reduce((sum, h) => sum + parseFloat(h.horas || 0), 0) : 0;

            return `
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-4">Registrar Horas</h3>
                        <div class="grid grid-cols-1 gap-3">
                            <input type="date" id="newHoraFecha" class="border rounded-lg px-3 py-2">
                            <input type="number" id="newHoraHoras" placeholder="Horas" class="border rounded-lg px-3 py-2" step="0.5">
                            <input type="text" id="newHoraDescripcion" placeholder="Descripción" class="border rounded-lg px-3 py-2">
                            <button onclick="agregarHoras()" class="text-white py-2 px-4 rounded-lg btn gradient-bg">Agregar</button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        ${obra.horas ? obra.horas.map(hora => `
                            <div class="bg-white border rounded-lg p-3">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-medium">${formatDate(hora.fecha)}</h4>
                                        <p class="text-sm text-gray-600">${hora.descripcion}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold">${hora.horas}h</p>
                                        <button onclick="eliminarHora('${hora.id}')" class="text-red-500 text-sm">Eliminar</button>
                                    </div>
                                </div>
                            </div>
                        `).join('') : ''}
                    </div>

                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="font-semibold text-green-800">Total Horas: ${totalHoras.toFixed(1)}h</h3>
                    </div>
                </div>
            `;
        }

        function renderFases(obra) {
            const completadas = fasesComunes.length - (obra.fasesPendientes ? obra.fasesPendientes.length : fasesComunes.length);
            const progreso = (completadas / fasesComunes.length) * 100;

            return `
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-4">Progreso del Proyecto</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progreso}%"></div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">${completadas} de ${fasesComunes.length} fases completadas (${Math.round(progreso)}%)</p>
                    </div>

                    <div class="space-y-2">
                        ${fasesComunes.map(fase => `
                            <div class="flex items-center gap-3 p-3 bg-white rounded-lg border">
                                <input type="checkbox" ${obra.fasesPendientes && !obra.fasesPendientes.includes(fase) ? 'checked' : ''} 
                                       onchange="toggleFase('${fase}')" class="w-5 h-5">
                                <span class="${obra.fasesPendientes && !obra.fasesPendientes.includes(fase) ? 'line-through text-gray-500' : ''}">${fase}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderFotos(obra) {
            return `
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-4">Subir Foto</h3>
                        <div class="space-y-3">
                            <input type="file" id="newFoto" accept="image/*" class="w-full border rounded-lg px-3 py-2">
                            <input type="text" id="newFotoDescripcion" placeholder="Descripción de la foto" class="w-full border rounded-lg px-3 py-2">
                            <button onclick="agregarFoto()" class="w-full text-white py-2 px-4 rounded-lg btn gradient-bg">Subir Foto</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        ${obra.fotos ? obra.fotos.map(foto => `
                            <div class="bg-white border rounded-lg p-2">
                                <img src="${foto.url}" alt="${foto.descripcion}" class="w-full h-32 object-cover rounded">
                                <p class="text-xs text-gray-600 mt-2">${foto.descripcion}</p>
                                <p class="text-xs text-gray-400">${formatDate(foto.fecha)}</p>
                                <button onclick="eliminarFoto('${foto.id}')" class="text-red-500 text-xs mt-1">Eliminar</button>
                            </div>
                        `).join('') : ''}
                    </div>

                    ${!obra.fotos || obra.fotos.length === 0 ? '<p class="text-gray-500 text-center py-8">No hay fotos subidas</p>' : ''}
                </div>
            `;
        }

        function renderMecanismos(obra) {
            const totalMecanismos = obra.mecanismos ? obra.mecanismos.reduce((sum, m) => sum + parseInt(m.cantidad || 0), 0) : 0;

            return `
                <div class="space-y-4">
                    <!-- Marca de Mecanismo -->
                    <div class="bg-yellow-50 rounded-lg p-4 border-l-4 border-yellow-400">
                        <h3 class="font-semibold mb-3 text-yellow-800">Marca de Mecanismo del Proyecto</h3>
                        <div class="flex gap-3">
                            <input type="text" id="marcaMecanismo" placeholder="Ej: Simon, Legrand, Jung..." 
                                   value="${obra.marcaMecanismo || ''}" 
                                   class="flex-1 border rounded-lg px-3 py-2">
                            <button onclick="guardarMarcaMecanismo()" class="text-white py-2 px-4 rounded-lg btn gradient-bg">
                                Guardar Marca
                            </button>
                        </div>
                    </div>

                    <!-- Lista de Mecanismos -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-4">Lista de Mecanismos</h3>
                        <div class="grid grid-cols-1 gap-3">
                            ${tiposMecanismos.map(tipo => {
                                const mecanismo = obra.mecanismos ? obra.mecanismos.find(m => m.tipo === tipo.id) : null;
                                const cantidad = mecanismo ? mecanismo.cantidad : 0;
                                
                                return `
                                    <div class="flex items-center gap-3 p-3 bg-white rounded-lg border">
                                        <span class="flex-1 font-medium">${tipo.nombre}</span>
                                        <div class="flex items-center gap-2">
                                            <button onclick="cambiarCantidadMecanismo('${tipo.id}', -1)" 
                                                    class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center">-</button>
                                            <span class="w-12 text-center font-bold">${cantidad}</span>
                                            <button onclick="cambiarCantidadMecanismo('${tipo.id}', 1)" 
                                                    class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center">+</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Resumen Total -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-800">Total Mecanismos: ${totalMecanismos}</h3>
                        ${obra.marcaMecanismo ? `<p class="text-blue-600 mt-1">Marca: ${obra.marcaMecanismo}</p>` : ''}
                    </div>

                    <!-- Lista Detallada -->
                    <div class="bg-white rounded-lg p-4 border">
                        <h3 class="font-semibold mb-3">Listado Detallado</h3>
                        <div class="space-y-2 text-sm">
                            ${obra.mecanismos ? obra.mecanismos.filter(m => m.cantidad > 0).map(mecanismo => {
                                const tipo = tiposMecanismos.find(t => t.id === mecanismo.tipo);
                                return `
                                    <div class="flex justify-between items-center py-1 border-b border-gray-100">
                                        <span>${tipo ? tipo.nombre : mecanismo.tipo}</span>
                                        <span class="font-medium">${mecanismo.cantidad}</span>
                                    </div>
                                `;
                            }).join('') : '<p class="text-gray-500">No hay mecanismos registrados</p>'}
                        </div>
                    </div>
                </div>
            `;
        }
        function renderComentarios(obra) {
            return `
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-4">Nuevo Comentario</h3>
                        <div class="space-y-3">
                            <textarea id="newComentario" placeholder="Escribe tu comentario..." rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
                            <button onclick="agregarComentario()" class="w-full text-white py-2 px-4 rounded-lg btn gradient-bg">Agregar Comentario</button>
                        </div>
                    </div>

                    <div class="space-y-3">
                        ${obra.comentarios ? obra.comentarios.map(comentario => `
                            <div class="bg-white border rounded-lg p-3">
                                <p class="text-sm">${comentario.texto}</p>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-xs text-gray-500">${formatDate(comentario.fecha)}</span>
                                    <button onclick="eliminarComentario('${comentario.id}')" class="text-red-500 text-xs">Eliminar</button>
                                </div>
                            </div>
                        `).join('') : ''}
                    </div>

                    ${!obra.comentarios || obra.comentarios.length === 0 ? '<p class="text-gray-500 text-center py-8">No hay comentarios</p>' : ''}
                </div>
            `;
        }
        }

        // Funciones de manejo de eventos
        function switchTab(tab) {
            appState.activeTab = tab;
            
            // Update tab appearance
            document.querySelectorAll('[id^="tab"]').forEach(t => {
                if (t.id.includes('Detalle')) return;
                t.classList.remove('tab-active');
                t.classList.add('border-transparent', 'text-gray-500');
            });
            
            const activeTabElement = document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            if (activeTabElement) {
                activeTabElement.classList.add('tab-active');
                activeTabElement.classList.remove('border-transparent', 'text-gray-500');
            }

            // Show/hide content
            document.getElementById('contentObras').classList.toggle('hidden', tab !== 'obras');
            document.getElementById('contentResumen').classList.toggle('hidden', tab !== 'resumen');

            if (tab === 'resumen') {
                renderResumen();
            }
        }

        function switchDetailTab(tab) {
            appState.activeDetailTab = tab;
            
            // Update tab appearance
            document.querySelectorAll('[id*="tab"][id*="Detalle"], [id^="tabMateriales"], [id^="tabHoras"], [id^="tabFases"], [id^="tabFotos"], [id^="tabComentarios"]').forEach(t => {
                t.classList.remove('tab-active');
                t.classList.add('border-transparent', 'text-gray-500');
            });
            
            const activeTabElement = document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}${tab === 'resumen' ? 'Detalle' : ''}`);
            if (activeTabElement) {
                activeTabElement.classList.add('tab-active');
                activeTabElement.classList.remove('border-transparent', 'text-gray-500');
            }

            renderDetalleContent();
        }

        function mostrarModal() {
            document.getElementById('modalObra').classList.remove('hidden');
        }

        function ocultarModal() {
            document.getElementById('modalObra').classList.add('hidden');
            limpiarFormulario();
            appState.editingObra = null;
        }

        function limpiarFormulario() {
            document.getElementById('formObra').reset();
        }

        function verDetalle(obraId) {
            const obra = appState.obras.find(o => o.id === obraId);
            if (!obra) return;

            appState.selectedObra = obra;
            appState.activeDetailTab = 'resumen';
            
            document.getElementById('detalleTitle').textContent = obra.nombre;
            document.getElementById('modalDetalle').classList.remove('hidden');
            
            // Reset tabs
            switchDetailTab('resumen');
        }

        function editarObra(obraId) {
            const obra = appState.obras.find(o => o.id === obraId);
            if (!obra) return;

            appState.editingObra = obra;
            
            // Fill form
            document.getElementById('nombre').value = obra.nombre;
            document.getElementById('cliente').value = obra.cliente;
            document.getElementById('direccion').value = obra.direccion || '';
            document.getElementById('estado').value = obra.estado;
            document.getElementById('presupuesto').value = obra.presupuesto || '';
            document.getElementById('fechaInicio').value = obra.fechaInicio || '';
            document.getElementById('fechaEstimadaFin').value = obra.fechaEstimadaFin || '';
            document.getElementById('descripcion').value = obra.descripcion || '';
            
            document.getElementById('modalTitle').textContent = 'Editar Obra';
            mostrarModal();
        }

        // Funciones CRUD
        function guardarObra(event) {
            event.preventDefault();
            
            const obra = {
                id: appState.editingObra ? appState.editingObra.id : generateId(),
                nombre: document.getElementById('nombre').value,
                cliente: document.getElementById('cliente').value,
                direccion: document.getElementById('direccion').value,
                estado: document.getElementById('estado').value,
                presupuesto: parseFloat(document.getElementById('presupuesto').value) || 0,
                fechaInicio: document.getElementById('fechaInicio').value,
                fechaEstimadaFin: document.getElementById('fechaEstimadaFin').value,
                descripcion: document.getElementById('descripcion').value,
                fechaCreacion: appState.editingObra ? appState.editingObra.fechaCreacion : new Date().toISOString(),
                materiales: appState.editingObra ? appState.editingObra.materiales : [],
                horas: appState.editingObra ? appState.editingObra.horas : [],
                fasesPendientes: appState.editingObra ? appState.editingObra.fasesPendientes : [...fasesComunes],
                fotos: appState.editingObra ? appState.editingObra.fotos : [],
                comentarios: appState.editingObra ? appState.editingObra.comentarios : [],
                marcaMecanismo: appState.editingObra ? appState.editingObra.marcaMecanismo : '',
                mecanismos: appState.editingObra ? appState.editingObra.mecanismos : []
            };

            if (appState.editingObra) {
                const index = appState.obras.findIndex(o => o.id === appState.editingObra.id);
                appState.obras[index] = obra;
            } else {
                appState.obras.push(obra);
            }

            saveData();
            renderObras();
            ocultarModal();
        }

        // Funciones para materiales
        function agregarMaterial() {
            const nombre = document.getElementById('newMaterialNombre').value;
            const cantidad = document.getElementById('newMaterialCantidad').value;
            const precio = parseFloat(document.getElementById('newMaterialPrecio').value) || 0;

            if (!nombre || !cantidad) return;

            const material = {
                id: generateId(),
                nombre,
                cantidad,
                precio,
                fecha: new Date().toISOString()
            };

            if (!appState.selectedObra.materiales) {
                appState.selectedObra.materiales = [];
            }

            appState.selectedObra.materiales.push(material);
            
            // Update in main array
            const index = appState.obras.findIndex(o => o.id === appState.selectedObra.id);
            if (index !== -1) {
                appState.obras[index] = appState.selectedObra;
            }
            
            saveData();
            renderDetalleContent();

            // Clear inputs
            document.getElementById('newMaterialNombre').value = '';
            document.getElementById('newMaterialCantidad').value = '';
            document.getElementById('newMaterialPrecio').value = '';
        }

        function eliminarMaterial(materialId) {
            if (appState.selectedObra.materiales) {
                appState.selectedObra.materiales = appState.selectedObra.materiales.filter(m => m.id !== materialId);
                
                // Update in main array
                const index = appState.obras.findIndex(o => o.id === appState.selectedObra.id);
                if (index !== -1) {
                    appState.obras[index] = appState.selectedObra;
                }
                
                saveData();
                renderDetalleContent();
            }
        }

        // Funciones para horas
        function agregarHoras() {
            const fecha = document.getElementById('newHoraFecha').value;
            const horas = parseFloat(document.getElementById('newHoraHoras').value) || 0;
            const descripcion = document.getElementById('newHoraDescripcion').value;

            if (!fecha || !horas) return;

            const hora = {
                id: generateId(),
                fecha,
                horas,
                descripcion
            };

            if (!appState.selectedObra.horas) {
                appState.selectedObra.horas = [];
            }

            appState.selectedObra.horas.push(hora);
            
            // Update in main array
            const index = appState.obras.findIndex(o => o.id === appState.selectedObra.id);
            if (index !== -1) {
                appState.obras[index] = appState.selectedObra;
            }
            
            saveData();
            renderDetalleContent();

            // Clear inputs
            document.getElementById('newHoraFecha').value = '';
            document.getElementById('newHoraHoras').value = '';
            document.getElementById('newHoraDescripcion').value = '';
        }

        function eliminarHora(horaId) {
            if (appState.selectedObra.horas) {
                appState.selectedObra.horas = appState.selectedObra.horas.filter(h => h.id !== horaId);
                
                // Update in main array
                const index = appState.obras.findIndex(o => o.id === appState.selectedObra.id);
                if (index !== -1) {
                    appState.obras[index] = appState.selectedObra;
                }
                
                saveData();
                renderDetalleContent();
            }
        }

        // Funciones para fases
        function toggleFase(fase) {
            if (!appState.selectedObra.fasesPendientes) {
                appState.selectedObra.fasesPendientes = [...fasesComunes];
            }
            
            const index = appState.selectedObra.fasesPendientes.indexOf(fase);
            if (index > -1) {
                appState.selectedObra.fasesPendientes.splice(index, 1);
            } else {
                appState.selectedObra.fasesPendientes.push(fase);
            }
            
            // Update in main array
            const obraIndex = appState.obras.findIndex(o => o.id === appState.selectedObra.id);
            if (obraIndex !== -1) {
                appState.obras[obraIndex] = appState.selectedObra;
            }
            
            saveData();
            renderDetalleContent();
        }

        // Funciones para fotos
        function agregarFoto() {
            const fileInput = document.getElementById('newFoto');
            const descripcion = document.getElementById('newFotoDescripcion').value;
            
            if (!fileInput.files[0]) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const foto = {
                    id: generateId(),
                    url: e.target.result,
                    descripcion: descripcion || 'Sin descripción',
                    fecha: new Date().toISOString()
                };

                if (!appState.selectedObra.fotos) {
                    appState.selectedObra.fotos = [];
                }

                appState.selectedObra.fotos.push(foto);
                
                // Update in main array
                const index = appState.obras.findIndex(o => o.id === appState.selectedObra.id);
                if (index !== -1) {
                    appState.obras[index] = appState.selectedObra;
                }
                
                saveData();
                renderDetalleContent();

                // Clear inputs
                fileInput.value = '';
                document.getElementById('newFotoDescripcion').value = '';
            };
            reader.readAsDataURL(fileInput.files[0]);
        }

        function eliminarFoto(fotoId) {
            if (appState.selectedObra.fotos) {
                appState.selectedObra.fotos = appState.selectedObra.fotos.filter(f => f.id !== fotoId);
                
                // Update in main array
                const index = appState.obras.findIndex(o => o.id === appState.selectedObra.id);
                if (index !== -1) {
                    appState.obras[index] = appState.selectedObra;
                }
                
                saveData();
                renderDetalleContent();
            }
        }

        // Funciones para mecanismos
        function guardarMarcaMecanismo() {
            const marca = document.getElementById('marcaMecanismo').value;
            if (!marca) return;

            appState.selectedObra.marcaMecanismo = marca;
            
            // Update in main array
            const index = appState.obras.findIndex(o => o.id === appState.selectedObra.id);
            if (index !== -1) {
                appState.obras[index] = appState.selectedObra;
            }
            
            saveData();
            renderDetalleContent();
        }

        function cambiarCantidadMecanismo(tipoId, cambio) {
            if (!appState.selectedObra.mecanismos) {
                appState.selectedObra.mecanismos = [];
            }

            const mecanismoIndex = appState.selectedObra.mecanismos.findIndex(m => m.tipo === tipoId);
            
            if (mecanismoIndex === -1) {
                // Crear nuevo mecanismo
                const nuevaCantidad = Math.max(0, cambio);
                if (nuevaCantidad > 0) {
                    appState.selectedObra.mecanismos.push({
                        tipo: tipoId,
                        cantidad: nuevaCantidad
                    });
                }
            } else {
                // Actualizar existente
                const nuevaCantidad = Math.max(0, appState.selectedObra.mecanismos[mecanismoIndex].cantidad + cambio);
                if (nuevaCantidad === 0) {
                    // Eliminar si cantidad es 0
                    appState.selectedObra.mecanismos.splice(mecanismoIndex, 1);
                } else {
                    appState.selectedObra.mecanismos[mecanismoIndex].cantidad = nuevaCantidad;
                }
            }
            
            // Update in main array
            const index = appState.obras.findIndex(o => o.id === appState.selectedObra.id);
            if (index !== -1) {
                appState.obras[index] = appState.selectedObra;
            }
            
            saveData();
            renderDetalleContent();
        }
        // Funciones para comentarios
        function agregarComentario() {
            const texto = document.getElementById('newComentario').value;
            if (!texto) return;

            const comentario = {
                id: generateId(),
                texto,
                fecha: new Date().toISOString()
            };

            if (!appState.selectedObra.comentarios) {
                appState.selectedObra.comentarios = [];
            }

            appState.selectedObra.comentarios.push(comentario);
            
            // Update in main array
            const index = appState.obras.findIndex(o => o.id === appState.selectedObra.id);
            if (index !== -1) {
                appState.obras[index] = appState.selectedObra;
            }
            
            saveData();
            renderDetalleContent();

            // Clear input
            document.getElementById('newComentario').value = '';
        }

        function eliminarComentario(comentarioId) {
            if (appState.selectedObra.comentarios) {
                appState.selectedObra.comentarios = appState.selectedObra.comentarios.filter(c => c.id !== comentarioId);
                
                // Update in main array
                const index = appState.obras.findIndex(o => o.id === appState.selectedObra.id);
                if (index !== -1) {
                    appState.obras[index] = appState.selectedObra;
                }
                
                saveData();
                renderDetalleContent();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Tab navigation
            document.getElementById('tabObras').addEventListener('click', () => switchTab('obras'));
            document.getElementById('tabResumen').addEventListener('click', () => switchTab('resumen'));

            // Detail tab navigation
            document.getElementById('tabResumenDetalle').addEventListener('click', () => switchDetailTab('resumen'));
            document.getElementById('tabMateriales').addEventListener('click', () => switchDetailTab('materiales'));
            document.getElementById('tabHoras').addEventListener('click', () => switchDetailTab('horas'));
            document.getElementById('tabFases').addEventListener('click', () => switchDetailTab('fases'));
            document.getElementById('tabMecanismos').addEventListener('click', () => switchDetailTab('mecanismos'));
            document.getElementById('tabFotos').addEventListener('click', () => switchDetailTab('fotos'));
            document.getElementById('tabComentarios').addEventListener('click', () => switchDetailTab('comentarios'));

            // Modal controls
            document.getElementById('btnNuevaObra').addEventListener('click', () => {
                document.getElementById('modalTitle').textContent = 'Nueva Obra';
                appState.editingObra = null;
                mostrarModal();
            });
            
            document.getElementById('btnCancelar').addEventListener('click', ocultarModal);
            document.getElementById('btnCerrarDetalle').addEventListener('click', () => {
                document.getElementById('modalDetalle').classList.add('hidden');
            });

            // Form submission
            document.getElementById('formObra').addEventListener('submit', guardarObra);

            // Search
            document.getElementById('searchInput').addEventListener('input', (e) => {
                appState.searchTerm = e.target.value;
                renderObras();
            });

            // Close modals on outside click
            document.getElementById('modalObra').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) ocultarModal();
            });

            // Initialize app
            renderObras();
        });
    </script>
</body>
</html>
